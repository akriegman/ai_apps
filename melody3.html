<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Intonation Ear Trainer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        text-align: center;
        max-width: 600px;
        margin: 0 auto;
        padding: 10px;
      }
      button {
        margin: 5px;
        padding: 5px 10px;
      }
      .guess-buttons {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        margin: 10px 0;
      }
      .guess-buttons button {
        width: 50px;
      }
      #centsButtons {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      #centsButtons button {
        width: 50px;
      }
      .cents-row {
        display: flex;
        justify-content: center;
      }
    </style>
  </head>
  <body>
    <h1>Intonation Ear Trainer</h1>
    <button id="playMelody">Play Melody</button>
    <div>
      <h3>Which note is out of tune?</h3>
      <div class="guess-buttons" id="noteButtons">
        <button data-note="1">1</button>
        <button data-note="2">2</button>
        <button data-note="3">3</button>
        <button data-note="4">4</button>
        <button data-note="5">5</button>
      </div>
    </div>
    <div>
      <h3>How many cents off?</h3>
      <div id="centsButtons">
        <!-- Buttons will be generated by JavaScript -->
      </div>
    </div>
    <button id="reset">Reset</button>
    <button id="submitGuess" disabled>Submit Guess</button>
    <p id="result"></p>
    <p id="score"></p>

    <script>
      /* 
    -- I like this, just a couple more changes: 
    -- let's make the buttons all have the same width,
    -- and the first row should go -5 to -25, and the second 5 to 25. 
    -- We should make it so the melody doesn't always start on the root. 
    -- Let's make the distribution of jumps approximately 
    -- follow a normal distribution. Lastly, 
    -- let's make it so the buttons stay pressed until you play the next melody,
    -- and let's move the score onto its own line.
    keep track of score
    */
      const synth = new Tone.Synth().toDestination();
      synth.oscillator.type = "sine";
      synth.oscillator.partials = [1, 0.75, 0.5, 0.1, 0.3];
      const majorScale = ["C", "D", "E", "F", "G", "A", "B"];
      const step = 10;
      const steps = 4;
      const length = 0.25;
      const maxJump = 7;
      let outOfTuneNote, outOfTuneCents;
      let melody;
      let noteGuess, centsGuess;
      let score = 0;

      function binomial(n, p) {
        let sum = 0;
        for (let i = 0; i < n; i++) {
          if (Math.random() < p) {
            sum++;
          }
        }
        return sum;
      }

      function reset() {
        melody = [];
        let currentIndex = 28 + Math.floor(Math.random() * majorScale.length); // Start in the middle of the scale
        for (let i = 0; i < 5; i++) {
          melody.push(
            `${majorScale[currentIndex % 7]}${Math.floor(currentIndex / 7)}`,
          );
          jump = binomial(2 * maxJump, 0.5) - maxJump;
          // reroll once to reduce jumps of 0
          if (jump == 0) {
            jump = binomial(2 * maxJump, 0.5) - maxJump;
          }
          currentIndex += jump;
        }
        outOfTuneNote = Math.floor(Math.random() * 5);
        outOfTuneCents =
          Math.ceil(Math.random() * steps) *
          step *
          (Math.random() < 0.5 ? -1 : 1);

        noteGuess = undefined;
        centsGuess = undefined;
        document
          .querySelectorAll("#noteButtons button, #centsButtons button")
          .forEach((btn) => {
            btn.style.backgroundColor = "";
            btn.disabled = false;
          });
        document.getElementById("reset").disabled = true;
        document.getElementById("result").textContent = "\xa0";
        document.getElementById("score").textContent = `Score: ${score}`;
      }

      reset();
      document.getElementById("reset").addEventListener("click", reset);

      function playMelody() {
        const now = Tone.now();
        melody.forEach((note, index) => {
          if (index === outOfTuneNote) {
            synth.triggerAttackRelease(
              Tone.Frequency(note).transpose(outOfTuneCents / 100),
              "8n",
              now + index * length,
            );
          } else {
            synth.triggerAttackRelease(note, "8n", now + index * length);
          }
        });
      }

      document
        .getElementById("playMelody")
        .addEventListener("click", playMelody);

      function formatSigned(num) {
        const sign = num > 0 ? "+" : "";
        return `${sign}${num}`;
      }

      // Generate cents buttons
      const centsButtonsContainer = document.getElementById("centsButtons");
      const positiveRow = document.createElement("div");
      positiveRow.className = "cents-row";
      const negativeRow = document.createElement("div");
      negativeRow.className = "cents-row";
      for (let i = -step * steps; i <= step * steps; i += step) {
        if (i !== 0) {
          const button = document.createElement("button");
          button.dataset.cents = i;
          button.textContent = formatSigned(i);
          if (i > 0) {
            positiveRow.appendChild(button);
          } else {
            negativeRow.appendChild(button);
          }
        }
      }
      const children = Array.from(negativeRow.childNodes);
      children.reverse();
      children.forEach((child) => negativeRow.appendChild(child));
      centsButtonsContainer.appendChild(negativeRow);
      centsButtonsContainer.appendChild(positiveRow);

      // Add event listeners to note buttons
      document.getElementById("noteButtons").addEventListener("click", (e) => {
        if (e.target.tagName === "BUTTON") {
          noteGuess = parseInt(e.target.dataset.note) - 1;
          document
            .querySelectorAll("#noteButtons button")
            .forEach((btn) => (btn.style.backgroundColor = ""));
          e.target.style.backgroundColor = "lightblue";
          checkGuessComplete();
        }
      });

      // Add event listeners to cents buttons
      document.getElementById("centsButtons").addEventListener("click", (e) => {
        if (e.target.tagName === "BUTTON") {
          centsGuess = parseInt(e.target.dataset.cents);
          document
            .querySelectorAll("#centsButtons button")
            .forEach((btn) => (btn.style.backgroundColor = ""));
          e.target.style.backgroundColor = "lightblue";
          checkGuessComplete();
        }
      });

      function checkGuessComplete() {
        document.getElementById("submitGuess").disabled =
          noteGuess === undefined || centsGuess === undefined;
      }

      document.getElementById("submitGuess").addEventListener("click", () => {
        const centsDistance = Math.abs(centsGuess - outOfTuneCents);

        const roundScore =
          noteGuess == outOfTuneNote ? 100 - centsDistance * 3 : -40;
        score += roundScore;

        document.getElementById("result").textContent =
          `The out of tune note was #${outOfTuneNote + 1}, ${formatSigned(outOfTuneCents)} cents off.`;
        document.getElementById("score").textContent =
          `Score: ${score} (${formatSigned(roundScore)})`;
        document.getElementById("submitGuess").disabled = true;
        document
          .querySelectorAll("#noteButtons button, #centsButtons button")
          .forEach((btn) => (btn.disabled = true));
        document.getElementById("reset").disabled = false;
      });
    </script>
  </body>
</html>
