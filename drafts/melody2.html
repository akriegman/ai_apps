<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Out of Tune Note Game</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        button { margin: 5px; padding: 5px 10px; }
        .guess-buttons { display: flex; flex-wrap: wrap; justify-content: center; margin: 10px 0; }
        .guess-buttons button { width: 50px; }
    </style>
</head>
<body>
    <h1>Out of Tune Note Game</h1>
    <button id="playMelody">Play Melody</button>
    <div>
        <h3>Which note is out of tune?</h3>
        <div class="guess-buttons" id="noteButtons">
            <button data-note="1">1</button>
            <button data-note="2">2</button>
            <button data-note="3">3</button>
            <button data-note="4">4</button>
            <button data-note="5">5</button>
        </div>
    </div>
    <div>
        <h3>How many cents off?</h3>
        <div class="guess-buttons" id="centsButtons">
            <!-- Buttons will be generated by JavaScript -->
        </div>
    </div>
    <button id="submitGuess" disabled>Submit Guess</button>
    <p id="result"></p>

    <script>
        const synth = new Tone.Synth().toDestination();
        const majorScale = ['C4', 'D4', 'E4', 'F4', 'G4', 'A4', 'B4', 'C5'];
        let outOfTuneNote, outOfTuneCents;
        let melody;
        let noteGuess, centsGuess;

        function generateMelody() {
            melody = [];
            for (let i = 0; i < 5; i++) {
                melody.push(majorScale[Math.floor(Math.random() * majorScale.length)]);
            }
            outOfTuneNote = Math.floor(Math.random() * 5);
            outOfTuneCents = (Math.floor(Math.random() * 8) + 1) * 5 * (Math.random() < 0.5 ? -1 : 1);
        }

        function playMelody() {
            if (!melody) generateMelody();
            const now = Tone.now();
            melody.forEach((note, index) => {
                if (index === outOfTuneNote) {
                    synth.triggerAttackRelease(Tone.Frequency(note).transpose(outOfTuneCents / 100), '4n', now + index * 0.5);
                } else {
                    synth.triggerAttackRelease(note, '4n', now + index * 0.5);
                }
            });
        }

        document.getElementById('playMelody').addEventListener('click', playMelody);

        // Generate cents buttons
        const centsButtonsContainer = document.getElementById('centsButtons');
        for (let i = -40; i <= 40; i += 5) {
            if (i !== 0) {
                const button = document.createElement('button');
                button.textContent = i;
                button.dataset.cents = i;
                centsButtonsContainer.appendChild(button);
            }
        }

        // Add event listeners to note buttons
        document.getElementById('noteButtons').addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                noteGuess = parseInt(e.target.dataset.note) - 1;
                document.querySelectorAll('#noteButtons button').forEach(btn => btn.style.backgroundColor = '');
                e.target.style.backgroundColor = 'lightblue';
                checkGuessComplete();
            }
        });

        // Add event listeners to cents buttons
        document.getElementById('centsButtons').addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                centsGuess = parseInt(e.target.dataset.cents);
                document.querySelectorAll('#centsButtons button').forEach(btn => btn.style.backgroundColor = '');
                e.target.style.backgroundColor = 'lightblue';
                checkGuessComplete();
            }
        });

        function checkGuessComplete() {
            document.getElementById('submitGuess').disabled = (noteGuess === undefined || centsGuess === undefined);
        }

        document.getElementById('submitGuess').addEventListener('click', () => {
            const noteDistance = Math.abs(noteGuess - outOfTuneNote);
            const centsDistance = Math.abs(centsGuess - outOfTuneCents);
            
            const score = 100 - (noteDistance * 10 + centsDistance);
            
            document.getElementById('result').textContent = `Your score: ${Math.max(0, score)}. The out of tune note was #${outOfTuneNote + 1}, ${outOfTuneCents} cents off.`;
            
            // Reset for next round
            melody = null;
            noteGuess = undefined;
            centsGuess = undefined;
            document.querySelectorAll('#noteButtons button, #centsButtons button').forEach(btn => btn.style.backgroundColor = '');
            document.getElementById('submitGuess').disabled = true;
        });
    </script>
</body>
</html>
